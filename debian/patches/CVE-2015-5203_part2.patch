From: Markus Koschany <apo@debian.org>
Date: Tue, 20 Nov 2018 17:06:01 +0100
Subject: CVE-2015-5203_part2

For a detailed analysis see
https://bugzilla.redhat.com/show_bug.cgi?id=1254242#c11

Origin: https://github.com/mdadams/jasper/commit/d42b2388f7f8e0332c846675133acea151fc557a#diff-6cf8c17c2a7595ef1481b68354696c37R379
---
 src/libjasper/base/jas_image.c          |  3 +--
 src/libjasper/include/jasper/jas_math.h | 14 ++++++++++++++
 2 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/src/libjasper/base/jas_image.c b/src/libjasper/base/jas_image.c
index ca1bd9a..d9f87b0 100644
--- a/src/libjasper/base/jas_image.c
+++ b/src/libjasper/base/jas_image.c
@@ -320,8 +320,7 @@ static jas_image_cmpt_t *jas_image_cmpt_create(uint_fast32_t tlx,
 	cmpt->cps_ = (depth + 7) / 8;
 
 	// size = cmpt->width_ * cmpt->height_ * cmpt->cps_;
-	if (!jas_safe_size_mul(cmpt->width_, cmpt->height_, &size) ||
-	  !jas_safe_size_mul(size, cmpt->cps_, &size)) {
+	if (!jas_safe_size_mul3(cmpt->width_, cmpt->height_, cmpt->cps_, &size)) {
 		goto error;
 	}
 	cmpt->stream_ = (inmem) ? jas_stream_memopen(0, size) :
diff --git a/src/libjasper/include/jasper/jas_math.h b/src/libjasper/include/jasper/jas_math.h
index e606afd..eccf2bc 100644
--- a/src/libjasper/include/jasper/jas_math.h
+++ b/src/libjasper/include/jasper/jas_math.h
@@ -124,6 +124,20 @@ inline static int jas_safe_size_mul(size_t x, size_t y, size_t *result)
         return 1;
 }
 
+inline static bool jas_safe_size_mul3(size_t a, size_t b, size_t c,
+  size_t *result)
+{
+	size_t tmp;
+	if (!jas_safe_size_mul(a, b, &tmp) ||
+	  !jas_safe_size_mul(tmp, c, &tmp)) {
+		return false;
+	}
+	if (result) {
+		*result = tmp;
+	}
+	return true;
+}
+
 #ifdef __cplusplus
 }
 #endif
